#!/bin/bash

# make a fresh pdf output directory
rm -rf pdf
mkdir -p pdf

# make a link to the images directory so html pages can refer to them
if [ ! -L pdf/images ]
then
    cd pdf && ln -s ../images ./images && cd ..
fi

# do the actual conversion
pandoc --lua-filter=boiler/output-blocks.lua --template=boiler/template.latex -o pdf/book.tex \
    title.md boiler/chapterbreak.tex \
    preface.md boiler/chapterbreak.tex \
    chapter01.md boiler/chapterbreak.tex \
    chapter02.md boiler/chapterbreak.tex \
    chapter03.md boiler/chapterbreak.tex \
    chapter04.md boiler/chapterbreak.tex \
    chapter05.md boiler/chapterbreak.tex \
    chapter06.md boiler/chapterbreak.tex \
    chapter07.md boiler/chapterbreak.tex \
    chapter08.md boiler/chapterbreak.tex \
    chapter09.md boiler/chapterbreak.tex \
    chapter10.md boiler/chapterbreak.tex


# we need special formatting for input inside of pre output blocks, so we made some thingies
sed -i 's/INPUTSTART/(*@\\textcolor{inputfg}{\\texttt{\\textbf{/' pdf/book.tex
sed -i 's/INPUTEND/}}}@*)/' pdf/book.tex

# we need to kill the footnotes section since Latex puts them at bottom of page
sed -i 's/subsection.Footnotes..label.footnote-label.*//' pdf/book.tex

# convert the latex into a pdf
cd pdf; pdflatex --interaction=batchmode book.tex; cd ..

mv pdf/book.pdf ./Exploring-Computer-Science.pdf

# remove unneeded output files
rm -rf pdf

